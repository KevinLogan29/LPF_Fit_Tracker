<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Limitless Performance and Fitness</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:black; color:#7ed957; }
    header { background:black; border-bottom:2px solid #7ed957; padding:10px; text-align:center; }
    nav { display:flex; justify-content:center; gap:10px; padding:10px; border-bottom:1px solid #7ed957; flex-wrap:wrap; }
    nav a { color:#7ed957; text-decoration:none; padding:5px 10px; border:1px solid #7ed957; border-radius:4px; }
    nav a:hover { background:#7ed957; color:black; }
    .page { display:none; padding:20px; }
    .active { display:block; }
    table { width:100%; border-collapse:collapse; margin-bottom:20px; border:1px solid #7ed957; }
    th,td { border:1px solid #7ed957; padding:6px; text-align:left; color:#7ed957; background:black; }
    th { background:black; }
    input, select, textarea { width:100%; padding:5px; box-sizing:border-box; background:black; color:#7ed957; border:1px solid #7ed957; }
    button { background:black; color:#7ed957; padding:6px 10px; border:1px solid #7ed957; border-radius:4px; cursor:pointer; }
    button:hover { background:#7ed957; color:black; }
    #total-volume { font-weight:bold; }
    .calc-section { margin-bottom: 30px; padding: 15px; border: 1px solid #7ed957; border-radius: 4px; }
    .result { font-weight: bold; background: #111; padding: 10px; margin-top: 10px; border-radius: 4px; }
    .delta { color: #7ed957; }
    .delta.positive { color: #7ed957; }
    .delta.negative { color: #d9577e; }
    .notes { background: #111; padding: 10px; margin: 10px 0; border-radius: 4px; border:1px solid #7ed957; }
    .date-input, .user-id-input { margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>Limitless Performance and Fitness</h1>
  </header>
  <nav>
    <a href="#" onclick="showPage('workout')">Workout Log</a>
    <a href="#" onclick="showPage('daily')">Daily Comments</a>
    <a href="#" onclick="showPage('nutrition')">Nutrition</a>
    <a href="#" onclick="showPage('cardio')">Cardio</a>
    <a href="#" onclick="showPage('performance')">Performance</a>
    <a href="#" onclick="showPage('calculators')">Calculators</a>
    <a href="#" onclick="showPage('progress')">Weekly Progress</a>
    <a href="#" onclick="showPage('hypertrophy')">Hypertrophy Blocks</a>
    <a href="#" onclick="showPage('strength')">Strength Blocks</a>
    <a href="#" onclick="showPage('mesocycle')">Mesocycles</a>
    <a href="#" onclick="showPage('history')">Workout History</a>
    <a href="#" onclick="showPage('analytics')">Analytics</a>
  </nav>

  <div id="workout" class="page active">
    <h2>Workout Log</h2>
    <div class="user-id-input">
      <label for="user_id">User ID (e.g., email):</label>
      <input type="text" id="user_id" placeholder="Enter your ID" required>
    </div>
    <div class="date-input">
      <label for="workout-date">Date:</label>
      <input type="date" id="workout-date">
    </div>
    <table id="workout-table">
      <thead>
        <tr>
          <th>Exercise</th><th>Sets</th><th>Weight</th><th>âˆ†Weight</th><th>Reps</th>
          <th>RIR</th><th>Pump</th><th>Felt</th><th>Rest</th><th>e1RM</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
      <tfoot>
        <tr>
          <td colspan="9" id="total-volume">Total Volume: 0 lbs | Total Sets: 0 | Volume Category: Low</td>
          <td colspan="2">
            <button onclick="addSet()">Add Set</button>
            <button onclick="saveWorkout()">Save Workout</button>
          </td>
        </tr>
      </tfoot>
    </table>
    <h3>Notes</h3>
    <textarea id="notes" rows="4" placeholder="Additional notes..."></textarea>
  </div>

  <!-- Other pages unchanged -->
  <div id="daily" class="page">...</div>
  <div id="nutrition" class="page">...</div>
  <div id="cardio" class="page">...</div>
  <div id="performance" class="page">...</div>
  <div id="calculators" class="page">...</div>
  <div id="progress" class="page">...</div>
  <div id="hypertrophy" class="page">...</div>
  <div id="strength" class="page">...</div>
  <div id="mesocycle" class="page">...</div>
  <div id="history" class="page">...</div>
  <div id="analytics" class="page">...</div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script>
    const API_URL = 'http://localhost:8000'; // Local FastAPI server

    const exercises = ["Lb Squat", "Bench Press", "Deadlift", /* ... */];
    const muscles = ["Pecs", "Lats", /* ... */];
    const initialHypertrophy = {/* ... */};
    const initialStickingPoints = {/* ... */};
    const suggestions = {/* ... */};

    let setNumber = 0;

    function addSet(ex="Exercise", wt="", reps="", rir="", pump="No", felt="", rest=120, e1rm=0) {
      setNumber++;
      const tr = document.createElement("tr");
      tr.className = "set-row";
      tr.innerHTML = `
        <td><input value="${ex}" onchange="calculateAll()"></td>
        <td>${setNumber}</td>
        <td><input type="number" value="${wt}" onchange="calculateAll()"></td>
        <td><span class="delta"></span></td>
        <td><input type="number" value="${reps}" onchange="calculateAll()"></td>
        <td><input type="number" value="${rir}" onchange="calculateAll()"></td>
        <td><select onchange="calculateAll()"><option ${pump==="No"?"selected":""}>No</option><option ${pump==="Yes"?"selected":""}>Yes</option></select></td>
        <td><input value="${felt}"></td>
        <td><input type="number" value="${rest}" onchange="calculateAll()"></td>
        <td><span>${e1rm}</span></td>
        <td><button onclick="this.closest('tr').remove();updateSetNumbers();calculateAll()">Remove</button></td>`;
      document.getElementById("table-body").appendChild(tr);
      calculateAll();
    }

    function updateSetNumbers() {
      const rows = document.querySelectorAll("#table-body .set-row");
      rows.forEach((r, i) => r.cells[1].textContent = i + 1);
      setNumber = rows.length;
    }

    function calculateAll() {
      let vol = 0, sets = 0;
      let prevWeight = 0;
      document.querySelectorAll("#table-body .set-row").forEach((r, index) => {
        const w = +r.cells[2].querySelector("input").value || 0;
        const reps = +r.cells[4].querySelector("input").value || 0;
        const rirI = r.cells[5].querySelector("input");
        let rir = +rirI.value || 0;
        rir = Math.max(0, Math.min(4, rir));
        rirI.value = rir;
        const deltaSpan = r.cells[3].querySelector(".delta");
        if (index > 0) {
          const delta = w - prevWeight;
          deltaSpan.textContent = delta > 0 ? `+${delta}` : delta;
          deltaSpan.className = `delta ${delta > 0 ? 'positive' : (delta < 0 ? 'negative' : '')}`;
        } else {
          deltaSpan.textContent = '';
        }
        prevWeight = w;
        if (w && reps) {
          vol += w * reps;
          sets++;
          r.cells[9].querySelector("span").textContent = Math.round(w * (36 / (37 - reps)));
        }
      });
      document.getElementById("total-volume").innerHTML = `Total Volume: ${vol} lbs | Total Sets: ${sets} | Volume Category: ${getVolumeCategory(sets)}`;
    }

    function getVolumeCategory(sets) {
      if (sets < 10) return 'Low';
      if (sets < 20) return 'Medium';
      return 'High';
    }

    async function saveWorkout() {
      const user_id = document.getElementById("user_id").value;
      if (!user_id) {
        alert("Please enter a User ID.");
        return;
      }
      const rows = [];
      document.querySelectorAll("#table-body .set-row").forEach(r => {
        rows.push({
          exercise: r.cells[0].querySelector("input").value,
          set_number: parseInt(r.cells[1].textContent),
          weight: parseFloat(r.cells[2].querySelector("input").value) || 0,
          reps: parseInt(r.cells[4].querySelector("input").value) || 0,
          rir: parseInt(r.cells[5].querySelector("input").value) || 0,
          pump: r.cells[6].querySelector("select").value,
          felt: r.cells[7].querySelector("input").value,
          rest: parseInt(r.cells[8].querySelector("input").value) || 0,
          e1rm: parseFloat(r.cells[9].querySelector("span").textContent) || 0
        });
      });
      const notes = document.getElementById("notes").value;
      const dateInput = document.getElementById("workout-date").value;
      const dateKey = dateInput || new Date().toISOString().split("T")[0];
      try {
        const response = await fetch(`${API_URL}/workouts/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id, date: dateKey, rows, notes })
        });
        if (response.ok) {
          alert("Workout saved!");
          displayWorkouts(user_id, dateKey);
        } else {
          throw new Error('Failed to save workout');
        }
      } catch (error) {
        console.error("Error saving workout:", error);
        alert("Error saving workout.");
      }
    }

    async function displayWorkouts(user_id, dateKey) {
      if (!user_id) {
        alert("Please enter a User ID to view workouts.");
        return;
      }
      try {
        const response = await fetch(`${API_URL}/workouts/${user_id}/${dateKey}`);
        const data = await response.json();
        const tb = document.getElementById("table-body");
        tb.innerHTML = "";
        setNumber = 0;
        let vol = 0, sets = 0;
        data.rows.forEach(r => {
          addSet(r.exercise, r.weight, r.reps, r.rir, r.pump, r.felt, r.rest, r.e1rm);
          vol += (r.weight || 0) * (r.reps || 0);
          sets++;
        });
        document.getElementById("notes").value = data.notes || "";
        document.getElementById("workout-date").value = dateKey;
        document.getElementById("total-volume").innerHTML = `Total Volume: ${vol} lbs | Total Sets: ${sets} | Volume Category: ${getVolumeCategory(sets)}`;
      } catch (error) {
        console.error("Error loading workouts:", error);
        alert("Error loading workouts.");
      }
    }

    async function loadHistory() {
      const tb = document.querySelector("#history-table tbody");
      tb.innerHTML = "";
      const user_id = document.getElementById("user_id").value;
      if (!user_id) {
        alert("Please enter a User ID to view history.");
        return;
      }
      try {
        const response = await fetch(`${API_URL}/workouts/history/${user_id}`);
        const data = await response.json();
        data.forEach(d => {
          tb.innerHTML += `<tr>
            <td>${d.date}</td>
            <td>${Math.round(d.total_volume)}</td>
            <td>${d.notes || ""}</td>
            <td>
              <button onclick="loadSpecific('${user_id}', '${d.date}')">View</button>
              <button onclick="downloadCSV('${user_id}', '${d.date}')">CSV</button>
              <button onclick="deleteWorkout('${user_id}', '${d.date}')">Delete</button>
            </td>
          </tr>`;
        });
      } catch (error) {
        console.error("Error loading history:", error);
        alert("Error loading history.");
      }
    }

    async function loadSpecific(user_id, dateKey) {
      displayWorkouts(user_id, dateKey);
      showPage("workout");
    }

    async function downloadCSV(user_id, dateKey) {
      try {
        const response = await fetch(`${API_URL}/workouts/${user_id}/${dateKey}`);
        const d = await response.json();
        let csv = "Exercise,Set,Weight,Delta,Reps,RIR,Pump,Felt,Rest,e1RM\n";
        d.rows.forEach(r => {
          csv += `${r.exercise},${r.set_number},${r.weight},,${r.reps},${r.rir},${r.pump},${r.felt},${r.rest},${r.e1rm}\n`;
        });
        csv += `Notes:,${(d.notes || "").replace(/[\n\r]/g, " ")}\n`;
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
        link.download = `${dateKey}-workout.csv`;
        link.click();
      } catch (error) {
        console.error("Error downloading CSV:", error);
        alert("Error downloading CSV.");
      }
    }

    async function deleteWorkout(user_id, dateKey) {
      if (confirm("Delete this workout?")) {
        try {
          const response = await fetch(`${API_URL}/workouts/${user_id}/${dateKey}`, { method: 'DELETE' });
          if (response.ok) {
            loadHistory();
          } else {
            throw new Error('Failed to delete workout');
          }
        } catch (error) {
          console.error("Error deleting workout:", error);
          alert("Error deleting workout.");
        }
      }
    }

    let e1rmChart;
    async function loadAnalytics() {
      const user_id = document.getElementById("user_id").value;
      if (!user_id) {
        alert("Please enter a User ID to view analytics.");
        return;
      }
      try {
        const response = await fetch(`${API_URL}/analytics/e1rm/${user_id}`);
        const { lifts, stats } = await response.json();
        const ctx = document.getElementById("e1rmChart").getContext("2d");
        if (e1rmChart) e1rmChart.destroy();
        e1rmChart = new Chart(ctx, {
          type: "line",
          data: {
            datasets: Object.keys(lifts).map((l, i) => ({
              label: l,
              data: lifts[l].map(d => ({ x: new Date(d.date), y: d.e1rm })),
              borderColor: ["#7ed957", "#57c7d9", "#d9577e"][i],
              tension: 0.3
            }))
          },
          options: { scales: { x: { type: "time", time: { unit: "day" } }, y: { title: { display: true, text: "e1RM" } } } }
        });
        const tb = document.querySelector("#stats-table tbody");
        tb.innerHTML = "";
        Object.keys(stats).forEach(l => {
          const s = stats[l];
          tb.innerHTML += `<tr><td>${l}</td><td>${s.first}</td><td>${s.latest}</td><td>${s.best}</td><td>${s.average.toFixed(1)}</td><td>${s.progress.toFixed(1)}%</td></tr>`;
        });
      } catch (error) {
        console.error("Error loading analytics:", error);
        alert("Error loading analytics.");
      }
    }

    function showPage(id) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (id === "history") loadHistory();
      if (id === "analytics") loadAnalytics();
      if (id === "progress") loadProgress();
      if (id === "hypertrophy") loadHypertrophy();
      if (id === "strength") { loadStrength(); loadRepMax(); loadStickingPoints(); }
      if (id === "mesocycle") loadMesocycle();
      if (id === "workout") setWorkoutDate();
    }

    function setWorkoutDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("workout-date").value = today;
    }

    function addDaily(date="",pain="",warm="",tired="",sore="",desire="",notes="") {
      // Your existing addDaily function unchanged
    }
    function saveDaily() {
      // Your existing saveDaily function unchanged
    }
    // ... Other unchanged functions: addNutrition, saveNutrition, addCardio, saveCardio,
    // addPerformance, savePerformance, loadRepMax, saveRepMax, loadStickingPoints,
    // saveStickingPoints, loadHypertrophy, saveHypertrophy, loadStrength, saveStrength,
    // loadMesocycle, saveMesocycle, loadProgress, calc1RM, calcBMI, calcBMR, calcMacros,
    // calcWilks

    window.onload = function() {
      setWorkoutDate();
      addSet("Lowbar Squat", 315, 5, 2, "No", "Quads", 120, 354);
      calculateAll();
      let daily = JSON.parse(localStorage.getItem("daily-log") || "[]");
      if (daily.length === 0) {
        addDaily("", "Mild discomfort", "Light", "A little tired", "Mild soreness", "High", "Upper");
        addDaily("", "Mild discomfort", "Did not train", "A little tired", "Mild soreness", "Average", "Lower");
        addDaily("", "Local joint pain discomfort", "Light", "A little tired", "Feel great", "High", "Push");
        addDaily("", "Local joint pain discomfort", "Heavy", "Tired on average", "Mild soreness", "Low", "Pull");
        addDaily("", "", "", "", "", "", "Rest day");
        daily = [
          {date: "", pain: "Mild discomfort", warm: "Light", tired: "A little tired", sore: "Mild soreness", desire: "High", notes: "Upper"},
          {date: "", pain: "Mild discomfort", warm: "Did not train", tired: "A little tired", sore: "Mild soreness", desire: "Average", notes: "Lower"},
          {date: "", pain: "Local joint pain discomfort", warm: "Light", tired: "A little tired", sore: "Feel great", desire: "High", notes: "Push"},
          {date: "", pain: "Local joint pain discomfort", warm: "Heavy", tired: "Tired on average", sore: "Mild soreness", desire: "Low", notes: "Pull"},
          {date: "", pain: "", warm: "", tired: "", sore: "", desire: "", notes: "Rest day"}
        ];
        localStorage.setItem("daily-log", JSON.stringify(daily));
      } else {
        daily.forEach(d => addDaily(d.date, d.pain, d.warm, d.tired, d.sore, d.desire, d.notes));
      }
      const nutrition = JSON.parse(localStorage.getItem("nutrition-log") || "[]");
      nutrition.forEach(n => addNutrition(n.date, n.cals, n.weight, n.steps, n.fat, n.carbs, n.protein, n.sleep, n.rhr, n.hrv));
      const perf = JSON.parse(localStorage.getItem("performance-log") || "[]");
      perf.forEach(p => addPerformance(p.date, p.lift, p.e1rm, p.status));
      const cardio = JSON.parse(localStorage.getItem("cardio-log") || "[]");
      if (cardio.length === 0) {
        addCardio("2025-02-03", "Treadmill", 30, 3, 3, 122);
        localStorage.setItem("cardio-log", JSON.stringify([{date: "2025-02-03", exercise: "Treadmill", minutes: 30, speed: 3, incline: 3, hrAvg: 122}]));
      } else {
        cardio.forEach(c => addCardio(c.date, c.exercise, c.minutes, c.speed, c.incline, c.hrAvg));
      }
      document.getElementById("user_id").addEventListener("change", (e) => {
        const dateKey = document.getElementById("workout-date").value || new Date().toISOString().split("T")[0];
        displayWorkouts(e.target.value, dateKey);
      });
    };
  </script>
</body>
</html>
