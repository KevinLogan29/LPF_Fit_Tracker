<script>
  // ----------------------------
  // Utility for LocalStorage
  // ----------------------------
  function getLocalData(key) { return JSON.parse(localStorage.getItem(key) || "{}"); }
  function setLocalData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

  // ----------------------------
  // WORKOUT LOG
  // ----------------------------
  let setNumber = 0;

  function addSet(ex = "Exercise", wt = "", reps = "", rir = "", pump = "No", felt = "", rest = 120, e1rm = 0) {
    setNumber++;
    const tr = document.createElement("tr");
    tr.className = "set-row";
    tr.innerHTML = `
      <td><input value="${ex}" onchange="calculateAll()"></td>
      <td>${setNumber}</td>
      <td><input type="number" min="0" value="${wt}" onchange="calculateAll()"></td>
      <td><span class="delta"></span></td>
      <td><input type="number" min="0" value="${reps}" onchange="calculateAll()"></td>
      <td><input type="number" min="0" max="4" value="${rir}" onchange="calculateAll()"></td>
      <td><select onchange="calculateAll()"><option ${pump==="No"?"selected":""}>No</option><option ${pump==="Yes"?"selected":""}>Yes</option></select></td>
      <td><input value="${felt}"></td>
      <td><input type="number" min="0" value="${rest}" onchange="calculateAll()"></td>
      <td><span>${e1rm}</span></td>
      <td><button onclick="this.closest('tr').remove();updateSetNumbers();calculateAll()">Remove</button></td>`;
    document.getElementById("table-body").appendChild(tr);
    calculateAll();
  }

  function updateSetNumbers() {
    const rows = document.querySelectorAll("#table-body .set-row");
    rows.forEach((r,i)=>r.cells[1].textContent=i+1);
    setNumber = rows.length;
  }

  function calculateAll() {
    let vol=0, sets=0, prevWeight=0;
    document.querySelectorAll("#table-body .set-row").forEach((r,index)=>{
      const w=parseFloat(r.cells[2].querySelector("input").value)||0;
      const reps=parseInt(r.cells[4].querySelector("input").value)||0;
      let rir=parseInt(r.cells[5].querySelector("input").value)||0;
      rir=Math.max(0,Math.min(4,rir));
      r.cells[5].querySelector("input").value=rir;
      const deltaSpan=r.cells[3].querySelector(".delta");
      if(index>0){ const delta=w-prevWeight; deltaSpan.textContent=delta>0?`+${delta}`:delta; deltaSpan.className=`delta ${delta>0?'positive':(delta<0?'negative':'')}`; }
      else deltaSpan.textContent='';
      prevWeight=w;
      if(w && reps){ vol+=w*reps; sets++; r.cells[9].querySelector("span").textContent=Math.round(w*(1+reps/30)); }
    });
    document.getElementById("total-volume").innerHTML=`Total Volume: ${vol} lbs | Total Sets: ${sets} | Volume Category: ${getVolumeCategory(sets)}`;
  }

  function getVolumeCategory(sets){ if(sets<10)return'Low'; if(sets<20)return'Medium'; return'High'; }

  function saveWorkout(){
    const user_id=document.getElementById("user_id").value.trim();
    if(!user_id){alert("Enter User ID"); return;}
    const rows=[];
    document.querySelectorAll("#table-body .set-row").forEach(r=>{
      rows.push({
        exercise:r.cells[0].querySelector("input").value.trim(),
        set_number:parseInt(r.cells[1].textContent),
        weight:parseFloat(r.cells[2].querySelector("input").value)||0,
        reps:parseInt(r.cells[4].querySelector("input").value)||0,
        rir:parseInt(r.cells[5].querySelector("input").value)||0,
        pump:r.cells[6].querySelector("select").value,
        felt:r.cells[7].querySelector("input").value.trim(),
        rest:parseInt(r.cells[8].querySelector("input").value)||0,
        e1rm:parseFloat(r.cells[9].querySelector("span").textContent)||0
      });
    });
    const dateKey=document.getElementById("workout-date").value||new Date().toISOString().split("T")[0];
    const notes=document.getElementById("notes").value.trim();
    const data=getLocalData("workouts");
    if(!data[user_id]) data[user_id]={};
    data[user_id][dateKey]={rows, notes};
    setLocalData("workouts", data);
    alert("Workout saved!");
  }

  // ----------------------------
  // DAILY COMMENTS
  // ----------------------------
  function addDaily(pain="", warmup="", tired="", sore="", desire="", notes="") {
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input value="${pain}"></td>
      <td><input value="${warmup}"></td>
      <td><input value="${tired}"></td>
      <td><input value="${sore}"></td>
      <td><input value="${desire}"></td>
      <td><input value="${notes}"></td>
      <td><button onclick="this.closest('tr').remove()">Remove</button></td>`;
    document.getElementById("daily-table-body").appendChild(tr);
  }

  function saveDaily(){
    const user_id=document.getElementById("daily-user_id").value.trim();
    if(!user_id){alert("Enter User ID"); return;}
    const rows=[];
    document.querySelectorAll("#daily-table-body tr").forEach(r=>{
      rows.push({
        pain:r.cells[0].querySelector("input").value,
        warmup:r.cells[1].querySelector("input").value,
        tired:r.cells[2].querySelector("input").value,
        sore:r.cells[3].querySelector("input").value,
        desire:r.cells[4].querySelector("input").value,
        notes:r.cells[5].querySelector("input").value
      });
    });
    const dateKey=document.getElementById("daily-date").value||new Date().toISOString().split("T")[0];
    const data=getLocalData("daily");
    if(!data[user_id]) data[user_id]={};
    data[user_id][dateKey]={rows};
    setLocalData("daily", data);
    alert("Daily log saved!");
  }

  // ----------------------------
  // NUTRITION
  // ----------------------------
  function addNutrition(cal=0, weight=0, steps=0, fat=0, carbs=0, protein=0, sleep=0, rhr=0, hrv=0) {
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input value="${cal}"></td>
      <td><input value="${weight}"></td>
      <td><input value="${steps}"></td>
      <td><input value="${fat}"></td>
      <td><input value="${carbs}"></td>
      <td><input value="${protein}"></td>
      <td><input value="${sleep}"></td>
      <td><input value="${rhr}"></td>
      <td><input value="${hrv}"></td>
      <td><button onclick="this.closest('tr').remove()">Remove</button></td>`;
    document.getElementById("nutrition-table-body").appendChild(tr);
  }

  function saveNutrition(){
    const user_id=document.getElementById("nutrition-user_id").value.trim();
    if(!user_id){alert("Enter User ID"); return;}
    const rows=[];
    document.querySelectorAll("#nutrition-table-body tr").forEach(r=>{
      rows.push({
        calories:r.cells[0].querySelector("input").value,
        weight:r.cells[1].querySelector("input").value,
        steps:r.cells[2].querySelector("input").value,
        fat:r.cells[3].querySelector("input").value,
        carbs:r.cells[4].querySelector("input").value,
        protein:r.cells[5].querySelector("input").value,
        sleep:r.cells[6].querySelector("input").value,
        rhr:r.cells[7].querySelector("input").value,
        hrv:r.cells[8].querySelector("input").value
      });
    });
    const dateKey=document.getElementById("nutrition-date").value||new Date().toISOString().split("T")[0];
    const data=getLocalData("nutrition");
    if(!data[user_id]) data[user_id]={};
    data[user_id][dateKey]={rows};
    setLocalData("nutrition", data);
    alert("Nutrition saved!");
  }

  // ----------------------------
  // CARDIO
  // ----------------------------
  function addCardio(ex="", min=0, speed=0, incline=0, hr=0) {
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input value="${ex}"></td>
      <td><input value="${min}"></td>
      <td><input value="${speed}"></td>
      <td><input value="${incline}"></td>
      <td><input value="${hr}"></td>
      <td><button onclick="this.closest('tr').remove()">Remove</button></td>`;
    document.getElementById("cardio-table-body").appendChild(tr);
  }

  function saveCardio(){
    const user_id=document.getElementById("cardio-user_id").value.trim();
    if(!user_id){alert("Enter User ID"); return;}
    const rows=[];
    document.querySelectorAll("#cardio-table-body tr").forEach(r=>{
      rows.push({
        exercise:r.cells[0].querySelector("input").value,
        minutes:r.cells[1].querySelector("input").value,
        speed:r.cells[2].querySelector("input").value,
        incline:r.cells[3].querySelector("input").value,
        hr:r.cells[4].querySelector("input").value
      });
    });
    const dateKey=document.getElementById("cardio-date").value||new Date().toISOString().split("T")[0];
    const data=getLocalData("cardio");
    if(!data[user_id]) data[user_id]={};
    data[user_id][dateKey]={rows};
    setLocalData("cardio", data);
    alert("Cardio saved!");
  }

  // ----------------------------
  // ANALYTICS
  // ----------------------------
  let e1rmChart;
  function loadAnalytics(){
    const user_id=document.getElementById("analytics-user_id").value.trim();
    if(!user_id){alert("Enter User ID"); return;}
    const data=getLocalData("workouts")[user_id]||{};
    const dates=Object.keys(data).sort();
    const volumes=dates.map(d=>data[d].rows.reduce((sum,r)=>sum+r.weight*r.reps,0));
    const ctx=document.getElementById("e1rmChart").getContext("2d");
    if(e1rmChart) e1rmChart.destroy();
    e1rmChart=new Chart(ctx,{
      type:"line",
      data:{ labels:dates, datasets:[{ label:"Workout Volume", data:volumes, borderColor:"#7ed957", backgroundColor:"rgba(126,217,87,0.2)", tension:0.3 }] },
      options:{ scales:{ y:{ title:{ display:true, text:"Volume (lbs)" } }, x:{ title:{ display:true, text:"Date" } } } }
    });
  }

  // ----------------------------
  // PAGE SWITCHING
  // ----------------------------
  function showPage(id){
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    if(id==="analytics") loadAnalytics();
  }

  // ----------------------------
  // INITIALIZATION
  // ----------------------------
  window.onload=function(){
    const today=new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(d=>d.value=today);
    addSet("Lowbar Squat", 315, 5, 2, "No", "Quads", 120, 354);
  };
</script>
