<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Limitless Performance and Fitness</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: black; color: #7ed957; }
    header { background: black; border-bottom: 2px solid #7ed957; padding: 10px; text-align: center; }
    nav { display: flex; justify-content: center; gap: 10px; padding: 10px; border-bottom: 1px solid #7ed957; flex-wrap: wrap; }
    nav a { color: #7ed957; text-decoration: none; padding: 5px 10px; border: 1px solid #7ed957; border-radius: 4px; }
    nav a:hover { background: #7ed957; color: black; }
    .page { display: none; padding: 20px; }
    .active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #7ed957; }
    th, td { border: 1px solid #7ed957; padding: 6px; text-align: left; color: #7ed957; background: black; }
    th { background: black; }
    input, select, textarea { width: 100%; padding: 5px; box-sizing: border-box; background: black; color: #7ed957; border: 1px solid #7ed957; }
    button { background: black; color: #7ed957; padding: 6px 10px; border: 1px solid #7ed957; border-radius: 4px; cursor: pointer; }
    button:hover { background: #7ed957; color: black; }
    #total-volume { font-weight: bold; }
    .calc-section { margin-bottom: 30px; padding: 15px; border: 1px solid #7ed957; border-radius: 4px; }
    .result { font-weight: bold; background: #111; padding: 10px; margin-top: 10px; border-radius: 4px; }
    .delta { color: #7ed957; }
    .delta.positive { color: #7ed957; }
    .delta.negative { color: #d9577e; }
    .notes { background: #111; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #7ed957; }
    .date-input, .user-id-input { margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>Limitless Performance and Fitness</h1>
  </header>
  <nav>
    <a href="#" onclick="showPage('workout')">Workout Log</a>
    <a href="#" onclick="showPage('daily')">Daily Comments</a>
    <a href="#" onclick="showPage('nutrition')">Nutrition</a>
    <a href="#" onclick="showPage('cardio')">Cardio</a>
    <a href="#" onclick="showPage('performance')">Performance</a>
    <a href="#" onclick="showPage('calculators')">Calculators</a>
    <a href="#" onclick="showPage('progress')">Weekly Progress</a>
    <a href="#" onclick="showPage('hypertrophy')">Hypertrophy Blocks</a>
    <a href="#" onclick="showPage('strength')">Strength Blocks</a>
    <a href="#" onclick="showPage('mesocycle')">Mesocycles</a>
    <a href="#" onclick="showPage('history')">Workout History</a>
    <a href="#" onclick="showPage('analytics')">Analytics</a>
  </nav>

  <div id="workout" class="page active">
    <h2>Workout Log</h2>
    <div class="user-id-input">
      <label for="user_id">User ID (e.g., email):</label>
      <input type="text" id="user_id" placeholder="Enter your ID" required>
    </div>
    <div class="date-input">
      <label for="workout-date">Date:</label>
      <input type="date" id="workout-date">
    </div>
    <table id="workout-table">
      <thead>
        <tr>
          <th>Exercise</th><th>Sets</th><th>Weight</th><th>âˆ†Weight</th><th>Reps</th>
          <th>RIR</th><th>Pump</th><th>Felt</th><th>Rest</th><th>e1RM</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
      <tfoot>
        <tr>
          <td colspan="9" id="total-volume">Total Volume: 0 lbs | Total Sets: 0 | Volume Category: Low</td>
          <td colspan="2">
            <button onclick="addSet()">Add Set</button>
            <button onclick="saveWorkout()">Save Workout</button>
          </td>
        </tr>
      </tfoot>
    </table>
    <h3>Notes</h3>
    <textarea id="notes" rows="4" placeholder="Additional notes..."></textarea>
  </div>

  <div id="daily" class="page">
    <h2>Daily Comments</h2>
    <div class="user-id-input">
      <label for="daily-user_id">User ID:</label>
      <input type="text" id="daily-user_id" placeholder="Enter your ID" required>
    </div>
    <div class="date-input">
      <label for="daily-date">Date:</label>
      <input type="date" id="daily-date">
    </div>
    <table id="daily-table">
      <thead>
        <tr>
          <th>Pain</th><th>Warm-up</th><th>Tired</th><th>Sore</th><th>Desire</th><th>Notes</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="daily-table-body"></tbody>
      <tfoot>
        <tr>
          <td colspan="7">
            <button onclick="addDaily()">Add Daily Log</button>
            <button onclick="saveDaily()">Save Daily Log</button>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div id="nutrition" class="page">
    <h2>Nutrition</h2>
    <div class="user-id-input">
      <label for="nutrition-user_id">User ID:</label>
      <input type="text" id="nutrition-user_id" placeholder="Enter your ID" required>
    </div>
    <div class="date-input">
      <label for="nutrition-date">Date:</label>
      <input type="date" id="nutrition-date">
    </div>
    <table id="nutrition-table">
      <thead>
        <tr>
          <th>Calories</th><th>Weight</th><th>Steps</th><th>Fat</th><th>Carbs</th><th>Protein</th>
          <th>Sleep</th><th>RHR</th><th>HRV</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="nutrition-table-body"></tbody>
      <tfoot>
        <tr>
          <td colspan="9">
            <button onclick="addNutrition()">Add Nutrition Log</button>
            <button onclick="saveNutrition()">Save Nutrition Log</button>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div id="cardio" class="page">
    <h2>Cardio</h2>
    <div class="user-id-input">
      <label for="cardio-user_id">User ID:</label>
      <input type="text" id="cardio-user_id" placeholder="Enter your ID" required>
    </div>
    <div class="date-input">
      <label for="cardio-date">Date:</label>
      <input type="date" id="cardio-date">
    </div>
    <table id="cardio-table">
      <thead>
        <tr>
          <th>Exercise</th><th>Minutes</th><th>Speed</th><th>Incline</th><th>Avg HR</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="cardio-table-body"></tbody>
      <tfoot>
        <tr>
          <td colspan="6">
            <button onclick="addCardio()">Add Cardio Log</button>
            <button onclick="saveCardio()">Save Cardio Log</button>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div id="performance" class="page">
    <h2>Performance</h2>
    <div class="user-id-input">
      <label for="performance-user_id">User ID:</label>
      <input type="text" id="performance-user_id" placeholder="Enter your ID" required>
    </div>
    <div class="date-input">
      <label for="performance-date">Date:</label>
      <input type="date" id="performance-date">
    </div>
    <table id="performance-table">
      <thead>
        <tr>
          <th>Lift</th><th>e1RM</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="performance-table-body"></tbody>
      <tfoot>
        <tr>
          <td colspan="4">
            <button onclick="addPerformance()">Add Performance Log</button>
            <button onclick="savePerformance()">Save Performance Log</button>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div id="calculators" class="page">
    <h2>Calculators</h2>
    <!-- Your existing calculator code -->
  </div>
  <div id="progress" class="page">
    <h2>Weekly Progress</h2>
    <!-- Your existing progress code -->
  </div>
  <div id="hypertrophy" class="page">
    <h2>Hypertrophy Blocks</h2>
    <!-- Your existing hypertrophy code -->
  </div>
  <div id="strength" class="page">
    <h2>Strength Blocks</h2>
    <!-- Your existing strength code -->
  </div>
  <div id="mesocycle" class="page">
    <h2>Mesocycles</h2>
    <!-- Your existing mesocycle code -->
  </div>
  <div id="history" class="page">
    <h2>Workout History</h2>
    <div class="user-id-input">
      <label for="history-user_id">User ID:</label>
      <input type="text" id="history-user_id" placeholder="Enter your ID" required>
    </div>
    <table id="history-table">
      <thead>
        <tr>
          <th>Date</th><th>Total Volume</th><th>Notes</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="analytics" class="page">
    <h2>Analytics</h2>
    <div class="user-id-input">
      <label for="analytics-user_id">User ID:</label>
      <input type="text" id="analytics-user_id" placeholder="Enter your ID" required>
    </div>
    <canvas id="e1rmChart"></canvas>
    <table id="stats-table">
      <thead>
        <tr>
          <th>Lift</th><th>First</th><th>Latest</th><th>Best</th><th>Average</th><th>Progress</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script>
    const API_URL = 'http://localhost:8000'; // Local FastAPI server

    const exercises = ["Lb Squat", "Bench Press", "Deadlift"];
    const muscles = ["Pecs", "Lats", "Quads", "Hamstrings", "Glutes", "Delts", "Biceps", "Triceps"];
    const initialHypertrophy = {};
    const initialStickingPoints = {};
    const suggestions = {};

    let setNumber = 0;

    // Workout Log
    function addSet(ex="Exercise", wt="", reps="", rir="", pump="No", felt="", rest=120, e1rm=0) {
      setNumber++;
      const tr = document.createElement("tr");
      tr.className = "set-row";
      tr.innerHTML = `
        <td><input value="${ex}" onchange="calculateAll()"></td>
        <td>${setNumber}</td>
        <td><input type="number" value="${wt}" onchange="calculateAll()"></td>
        <td><span class="delta"></span></td>
        <td><input type="number" value="${reps}" onchange="calculateAll()"></td>
        <td><input type="number" value="${rir}" onchange="calculateAll()"></td>
        <td><select onchange="calculateAll()"><option ${pump==="No"?"selected":""}>No</option><option ${pump==="Yes"?"selected":""}>Yes</option></select></td>
        <td><input value="${felt}"></td>
        <td><input type="number" value="${rest}" onchange="calculateAll()"></td>
        <td><span>${e1rm}</span></td>
        <td><button onclick="this.closest('tr').remove();updateSetNumbers();calculateAll()">Remove</button></td>`;
      document.getElementById("table-body").appendChild(tr);
      calculateAll();
    }

    function updateSetNumbers() {
      const rows = document.querySelectorAll("#table-body .set-row");
      rows.forEach((r, i) => r.cells[1].textContent = i + 1);
      setNumber = rows.length;
    }

    function calculateAll() {
      let vol = 0, sets = 0;
      let prevWeight = 0;
      document.querySelectorAll("#table-body .set-row").forEach((r, index) => {
        const w = +r.cells[2].querySelector("input").value || 0;
        const reps = +r.cells[4].querySelector("input").value || 0;
        const rirI = r.cells[5].querySelector("input");
        let rir = +rirI.value || 0;
        rir = Math.max(0, Math.min(4, rir));
        rirI.value = rir;
        const deltaSpan = r.cells[3].querySelector(".delta");
        if (index > 0) {
          const delta = w - prevWeight;
          deltaSpan.textContent = delta > 0 ? `+${delta}` : delta;
          deltaSpan.className = `delta ${delta > 0 ? 'positive' : (delta < 0 ? 'negative' : '')}`;
        } else {
          deltaSpan.textContent = '';
        }
        prevWeight = w;
        if (w && reps) {
          vol += w * reps;
          sets++;
          r.cells[9].querySelector("span").textContent = Math.round(w * (36 / (37 - reps)));
        }
      });
      document.getElementById("total-volume").innerHTML = `Total Volume: ${vol} lbs | Total Sets: ${sets} | Volume Category: ${getVolumeCategory(sets)}`;
    }

    function getVolumeCategory(sets) {
      if (sets < 10) return 'Low';
      if (sets < 20) return 'Medium';
      return 'High';
    }

    async function saveWorkout() {
      const user_id = document.getElementById("user_id").value;
      if (!user_id) {
        alert("Please enter a User ID.");
        return;
      }
      const rows = [];
      document.querySelectorAll("#table-body .set-row").forEach(r => {
        rows.push({
          exercise: r.cells[0].querySelector("input").value,
          set_number: parseInt(r.cells[1].textContent),
          weight: parseFloat(r.cells[2].querySelector("input").value) || 0,
          reps: parseInt(r.cells[4].querySelector("input").value) || 0,
          rir: parseInt(r.cells[5].querySelector("input").value) || 0,
          pump: r.cells[6].querySelector("select").value,
          felt: r.cells[7].querySelector("input").value,
          rest: parseInt(r.cells[8].querySelector("input").value) || 0,
          e1rm: parseFloat(r.cells[9].querySelector("span").textContent) || 0
        });
      });
      const notes = document.getElementById("notes").value;
      const dateInput = document.getElementById("workout-date").value;
      const dateKey = dateInput || new Date().toISOString().split("T")[0];
      try {
        const response = await fetch(`${API_URL}/workouts/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id, date: dateKey, rows, notes })
        });
        if (response.ok) {
          alert("Workout saved!");
          displayWorkouts(user_id, dateKey);
        } else {
          throw new Error('Failed to save workout');
        }
      } catch (error) {
        console.error("Error saving workout:", error);
        alert("Error saving workout.");
      }
    }

    async function displayWorkouts(user_id, dateKey) {
      if (!user_id) {
        alert("Please enter a User ID to view workouts.");
        return;
      }
      try {
        const response = await fetch(`${API_URL}/workouts/${user_id}/${dateKey}`);
        const data = await response.json();
        const tb = document.getElementById("table-body");
        tb.innerHTML = "";
        setNumber = 0;
        let vol = 0, sets = 0;
        data.rows.forEach(r => {
          addSet(r.exercise, r.weight, r.reps, r.rir, r.pump, r.felt, r.rest, r.e1rm);
          vol += (r.weight || 0) * (r.reps || 0);
          sets++;
        });
        document.getElementById("notes").value = data.notes || "";
        document.getElementById("workout-date").value = dateKey;
        document.getElementById("total-volume").innerHTML = `Total Volume: ${vol} lbs | Total Sets: ${sets} | Volume Category: ${getVolumeCategory(sets)}`;
      } catch (error) {
        console.error("Error loading workouts:", error);
        alert("Error loading workouts.");
      }
    }

    // Daily Log
    function addDaily(date="", pain="", warm="", tired="", sore="", desire="", notes="") {
      const tr = document.createElement("tr");
      tr.className = "daily-row";
      tr.innerHTML = `
        <td><input value="${pain}"></td>
        <td><input value="${warm}"></td>
        <td><input value="${tired}"></td>
        <td><input value="${sore}"></td>
        <td><input value="${desire}"></td>
        <td><input value="${notes}"></td>
        <td><button onclick="this.closest('tr').remove()">Remove</button></td>`;
      document.getElementById("daily-table-body").appendChild(tr);
    }

    async function saveDaily() {
      const user_id = document.getElementById("daily-user_id").value;
      if (!user_id) {
        alert("Please enter a User ID.");
        return;
      }
      const dateInput = document.getElementById("daily-date").value;
      const dateKey = dateInput || new Date().toISOString().split("T")[0];
      const rows = document.querySelectorAll("#daily-table-body .daily-row");
      if (rows.length === 0) {
        alert("Please add a daily log entry.");
        return;
      }
      const data = {
        user_id,
        date: dateKey,
        pain: rows[0].cells[0].querySelector("input").value,
        warm: rows[0].cells[1].querySelector("input").value,
        tired: rows[0].cells[2].querySelector("input").value,
        sore: rows[0].cells[3].querySelector("input").value,
        desire: rows[0].cells[4].querySelector("input").value,
        notes: rows[0].cells[5].querySelector("input").value
      };
      try {
        const response = await fetch(`${API_URL}/daily/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          alert("Daily log saved!");
          displayDaily(user_id, dateKey);
        } else {
          throw new Error('Failed to save daily log');
        }
      } catch (error) {
        console.error("Error saving daily log:", error);
        alert("Error saving daily log.");
      }
    }

    async function displayDaily(user_id, dateKey) {
      if (!user_id) {
        alert("Please enter a User ID to view daily logs.");
        return;
      }
      try {
        const response = await fetch(`${API_URL}/daily/${user_id}/${dateKey}`);
        const data = await response.json();
        const tb = document.getElementById("daily-table-body");
        tb.innerHTML = "";
        if (data.pain) {
          addDaily(dateKey, data.pain, data.warm, data.tired, data.sore, data.desire, data.notes);
        }
        document.getElementById("daily-date").value = dateKey;
      } catch (error) {
        console.error("Error loading daily log:", error);
        alert("Error loading daily log.");
      }
    }

    // Nutrition Log
    function addNutrition(date="", cals="", weight="", steps="", fat="", carbs="", protein="", sleep="", rhr="", hrv="") {
      const tr = document.createElement("tr");
      tr.className = "nutrition-row";
      tr.innerHTML = `
        <td><input type="number" value="${cals}"></td>
        <td><input type="number" value="${weight}"></td>
        <td><input type="number" value="${steps}"></td>
        <td><input type="number" value="${fat}"></td>
        <td><input type="number" value="${carbs}"></td>
        <td><input type="number" value="${protein}"></td>
        <td><input type="number" value="${sleep}"></td>
        <td><input type="number" value="${rhr}"></td>
        <td><input type="number" value="${hrv}"></td>
        <td><button onclick="this.closest('tr').remove()">Remove</button></td>`;
      document.getElementById("nutrition-table-body").appendChild(tr);
    }

    async function saveNutrition() {
      const user_id = document.getElementById("nutrition-user_id").value;
      if (!user_id) {
        alert("Please enter a User ID.");
        return;
      }
      const dateInput = document.getElementById("nutrition-date").value;
      const dateKey = dateInput || new Date().toISOString().split("T")[0];
      const rows = document.querySelectorAll("#nutrition-table-body .nutrition-row");
      if (rows.length === 0) {
        alert("Please add a nutrition log entry.");
        return;
      }
      const data = {
        user_id,
        date: dateKey,
        calories: parseInt(rows[0].cells[0].querySelector("input").value) || 0,
        weight: parseFloat(rows[0].cells[1].querySelector("input").value) || 0,
        steps: parseInt(rows[0].cells[2].querySelector("input").value) || 0,
        fat: parseInt(rows[0].cells[3].querySelector("input").value) || 0,
        carbs: parseInt(rows[0].cells[4].querySelector("input").value) || 0,
        protein: parseInt(rows[0].cells[5].querySelector("input").value) || 0,
        sleep: parseFloat(rows[0].cells[6].querySelector("input").value) || 0,
        rhr: parseInt(rows[0].cells[7].querySelector("input").value) || 0,
        hrv: parseInt(rows[0].cells[8].querySelector("input").value) || 0
      };
      try {
        const response = await fetch(`${API_URL}/nutrition/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          alert("Nutrition log saved!");
          displayNutrition(user_id, dateKey);
        } else {
          throw new Error('Failed to save nutrition log');
        }
      } catch (error) {
        console.error("Error saving nutrition log:", error);
        alert("Error saving nutrition log.");
      }
    }

    async function displayNutrition(user_id, dateKey) {
      if (!user_id) {
        alert("Please enter a User ID to view nutrition logs.");
        return;
      }
      try {
        const response = await fetch(`${API_URL}/nutrition/${user_id}/${dateKey}`);
        const data = await response.json();
        const tb = document.getElementById("nutrition-table-body");
        tb.innerHTML = "";
        if (data.calories) {
          addNutrition(dateKey, data.calories, data.weight, data.steps, data.fat, data.carbs, data.protein, data.sleep, data.rhr, data.hrv);
        }
        document.getElementById("nutrition-date").value = dateKey;
      } catch (error) {
        console.error("Error loading nutrition log:", error);
        alert("Error loading nutrition log.");
      }
    }

    // Cardio Log
    function addCardio(date="", exercise="", minutes="", speed="", incline="", hr_avg="") {
      const tr = document.createElement("tr");
      tr.className = "cardio-row";
      tr.innerHTML = `
        <td><input value="${exercise}"></td>
        <td><input type="number" value="${minutes}"></td>
        <td><input type="number" value="${speed}"></td>
        <td><input type="number" value="${incline}"></td>
        <td><input type="number" value="${hr_avg}"></td>
        <td><button onclick="this.closest('tr').remove()">Remove</button></td>`;
      document.getElementById("cardio-table-body").appendChild(tr);
    }

    async function saveCardio() {
      const user_id = document.getElementById("cardio-user_id").value;
      if (!user_id) {
        alert("Please enter a User ID.");
        return;
      }
      const dateInput = document.getElementById("cardio-date").value;
      const dateKey = dateInput || new Date().toISOString().split("T")[0];
      const rows = document.querySelectorAll("#cardio-table-body .cardio-row");
      for (const row of rows) {
        const data = {
          user_id,
          date: dateKey,
          exercise: row.cells[0].querySelector("input").value,
          minutes: parseInt(row.cells[1].querySelector("input").value) || 0,
          speed: parseFloat(row.cells[2].querySelector("input").value) || 0,
          incline: parseFloat(row.cells[3].querySelector("input").value) || 0,
          hr_avg: parseInt(row.cells[4].querySelector("input").value) || 0
        };
        try {
          const response = await fetch(`${API_URL}/cardio/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (!response.ok) {
            throw new Error('Failed to save cardio log');
          }
        } catch (error) {
          console.error("Error saving cardio log:", error);
          alert("Error saving cardio log.");
          return;
        }
      }
      alert("Cardio log saved!");
      displayCardio(user_id, dateKey);
    }

    async function displayCardio(user_id, dateKey) {
      if (!user_id) {
        alert("Please enter a User ID to view cardio logs.");
        return;
      }
      try {
        const response = await fetch(`${API_URL}/cardio/${user_id}/${dateKey}`);
        const data = await response.json();
        const tb = document.getElementById("cardio-table-body");
        tb.innerHTML = "";
        data.forEach(r => {
          addCardio(dateKey, r.exercise, r.minutes, r.speed, r.incline, r.hr_avg);
        });
        document.getElementById("cardio-date").value = dateKey;
      } catch (error) {
        console.error("Error loading cardio log:", error);
        alert("Error loading cardio log.");
      }
    }

    // Performance Log
    function addPerformance(date="", lift="", e1rm="", status="") {
      const tr = document.createElement("tr");
      tr.className = "performance-row";
      tr.innerHTML = `
        <td><input value="${lift}"></td>
        <td><input type="number" value="${e1rm}"></td>
        <td><input value="${status}"></td>
        <td><button onclick="this.closest('tr').remove()">Remove</button></td>`;
      document.getElementById("performance-table-body").appendChild(tr);
    }

    async function savePerformance() {
      const user_id = document.getElementById("performance-user_id").value;
      if (!user_id) {
        alert("Please enter a User ID.");
        return;
      }
      const dateInput = document.getElementById("performance-date").value;
      const dateKey = dateInput || new Date().toISOString().split("T")[0];
      const rows = document.querySelectorAll("#performance-table-body .performance-row");
      for (const row of rows) {
        const data = {
          user_id,
          date: dateKey,
          lift: row.cells[0].querySelector("input").value,
          e1rm: parseFloat(row.cells[1].querySelector("input").value) || 0,
          status: row.cells[2].querySelector("input").value
        };
        try {
          const response = await fetch(`${API_URL}/performance/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (!response.ok) {
            throw new Error('Failed to save performance log');
          }
        } catch (error) {
          console.error("Error saving performance log:", error);
          alert("Error saving performance log.");
          return;
        }
      }
      alert("Performance log saved!");
      displayPerformance(user_id, dateKey);
    }

    async function displayPerformance(user_id, dateKey) {
      if (!user_id) {
        alert("Please enter a User ID to view performance logs.");
        return;
      }
      try {
        const response = await fetch(`${API_URL}/performance/${user_id}/${dateKey}`);
        const data = await response.json();
        const tb = document.getElementById("performance-table-body");
        tb.innerHTML = "";
        data.forEach(r => {
          addPerformance(dateKey, r.lift, r.e1rm, r.status);
        });
        document.getElementById("performance-date").value = dateKey;
      } catch (error) {
        console.error("Error loading performance log:", error);
        alert("Error loading performance log.");
      }
    }

    // History and Analytics
    async function loadHistory() {
      const tb = document.querySelector("#history-table tbody");
      tb.innerHTML = "";
      const user_id = document.getElementById("history-user_id").value;
      if (!user_id) {
        alert("Please enter a User ID to view history.");
        return;
      }
      try {
        const response = await fetch(`${API_URL}/workouts/history/${user_id}`);
        const data = await response.json();
        data.forEach(d => {
          tb.innerHTML += `<tr>
            <td>${d.date}</td>
            <td>${Math.round(d.total_volume)}</td>
            <td>${d.notes || ""}</td>
            <td>
              <button onclick="loadSpecific('${user_id}', '${d.date}')">View</button>
              <button onclick="downloadCSV('${user_id}', '${d.date}')">CSV</button>
              <button onclick="deleteWorkout('${user_id}', '${d.date}')">Delete</button>
            </td>
          </tr>`;
        });
      } catch (error) {
        console.error("Error loading history:", error);
        alert("Error loading history.");
      }
    }

    async function loadSpecific(user_id, dateKey) {
      displayWorkouts(user_id, dateKey);
      showPage("workout");
    }

    async function downloadCSV(user_id, dateKey) {
      try {
        const response = await fetch(`${API_URL}/workouts/${user_id}/${dateKey}`);
        const d = await response.json();
        let csv = "Exercise,Set,Weight,Delta,Reps,RIR,Pump,Felt,Rest,e1RM\n";
        d.rows.forEach(r => {
          csv += `${r.exercise},${r.set_number},${r.weight},,${r.reps},${r.rir},${r.pump},${r.felt},${r.rest},${r.e1rm}\n`;
        });
        csv += `Notes:,${(d.notes || "").replace(/[\n\r]/g, " ")}\n`;
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
        link.download = `${dateKey}-workout.csv`;
        link.click();
      } catch (error) {
        console.error("Error downloading CSV:", error);
        alert("Error downloading CSV.");
      }
    }

    async function deleteWorkout(user_id, dateKey) {
      if (confirm("Delete this workout?")) {
        try {
          const response = await fetch(`${API_URL}/workouts/${user_id}/${dateKey}`, { method: 'DELETE' });
          if (response.ok) {
            loadHistory();
          } else {
            throw new Error('Failed to delete workout');
          }
        } catch (error) {
          console.error("Error deleting workout:", error);
          alert("Error deleting workout.");
        }
      }
    }

    let e1rmChart;
    async function loadAnalytics() {
      const user_id = document.getElementById("analytics-user_id").value;
      if (!user_id) {
        alert("Please enter a User ID to view analytics.");
        return;
      }
      try {
        const response = await fetch(`${API_URL}/analytics/e1rm/${user_id}`);
        const { lifts, stats } = await response.json();
        const ctx = document.getElementById("e1rmChart").getContext("2d");
        if (e1rmChart) e1rmChart.destroy();
        e1rmChart = new Chart(ctx, {
          type: "line",
          data: {
            datasets: Object.keys(lifts).map((l, i) => ({
              label: l,
              data: lifts[l].map(d => ({ x: new Date(d.date), y: d.e1rm })),
              borderColor: ["#7ed957", "#57c7d9", "#d9577e"][i],
              tension: 0.3
            }))
          },
          options: { scales: { x: { type: "time", time: { unit: "day" } }, y: { title: { display: true, text: "e1RM" } } } }
        });
        const tb = document.querySelector("#stats-table tbody");
        tb.innerHTML = "";
        Object.keys(stats).forEach(l => {
          const s = stats[l];
          tb.innerHTML += `<tr><td>${l}</td><td>${s.first}</td><td>${s.latest}</td><td>${s.best}</td><td>${s.average.toFixed(1)}</td><td>${s.progress.toFixed(1)}%</td></tr>`;
        });
      } catch (error) {
        console.error("Error loading analytics:", error);
        alert("Error loading analytics.");
      }
    }

    // Placeholder functions for other pages
    function loadProgress() {}
    function loadHypertrophy() {}
    function loadStrength() {}
    function loadRepMax() {}
    function loadStickingPoints() {}
    function loadMesocycle() {}
    function calc1RM() {}
    function calcBMI() {}
    function calcBMR() {}
    function calcMacros() {}
    function calcWilks() {}

    function showPage(id) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (id === "history") loadHistory();
      if (id === "analytics") loadAnalytics();
      if (id === "progress") loadProgress();
      if (id === "hypertrophy") loadHypertrophy();
      if (id === "strength") { loadStrength(); loadRepMax(); loadStickingPoints(); }
      if (id === "mesocycle") loadMesocycle();
      if (id === "workout") setWorkoutDate();
      if (id === "daily") setDailyDate();
      if (id === "nutrition") setNutritionDate();
      if (id === "cardio") setCardioDate();
      if (id === "performance") setPerformanceDate();
    }

    function setWorkoutDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("workout-date").value = today;
    }

    function setDailyDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("daily-date").value = today;
    }

    function setNutritionDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("nutrition-date").value = today;
    }

    function setCardioDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("cardio-date").value = today;
    }

    function setPerformanceDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("performance-date").value = today;
    }

    window.onload = function() {
      setWorkoutDate();
      setDailyDate();
      setNutritionDate();
      setCardioDate();
      setPerformanceDate();
      addSet("Lowbar Squat", 315, 5, 2, "No", "Quads", 120, 354);
      addDaily("", "Mild discomfort", "Light", "A little tired", "Mild soreness", "High", "Upper");
      addNutrition("", 2500, 180, 10000, 80, 300, 150, 7.5, 60, 50);
      addCardio("", "Treadmill", 30, 3, 3, 122);
      addPerformance("", "Squat", 354, "Good");
      calculateAll();
    };
  </script>
</body>
</html>
