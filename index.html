<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Your existing <head> with styles unchanged -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Limitless Performance and Fitness</title>
  <style>
    /* Your existing styles unchanged */
    body { font-family: Arial, sans-serif; margin: 0; background:black; color:#7ed957; }
    /* ... rest of your styles ... */
  </style>
</head>
<body>
  <!-- Your existing header and nav unchanged -->
  <header>
    <h1>Limitless Performance and Fitness</h1>
  </header>
  <nav>
    <!-- Your nav links unchanged -->
  </nav>

  <!-- Workout Log (Updated for Firestore) -->
  <div id="workout" class="page active">
    <h2>Workout Log</h2>
    <div class="date-input">
      <label for="workout-date">Date:</label>
      <input type="date" id="workout-date">
    </div>
    <div>
      <label for="memberId">Member ID:</label>
      <input type="text" id="memberId" placeholder="Member ID (e.g., email)" required>
    </div>
    <table id="workout-table">
      <thead>
        <tr>
          <th>Exercise</th><th>Sets</th><th>Weight</th><th>âˆ†Weight</th><th>Reps</th>
          <th>RIR</th><th>Pump</th><th>Felt</th><th>Rest</th><th>e1RM</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
      <tfoot>
        <tr>
          <td colspan="9" id="total-volume">Total Volume: 0 lbs | Total Sets: 0 | Volume Category: Low</td>
          <td colspan="2">
            <button onclick="addSet()">Add Set</button>
            <button onclick="saveWorkout()">Save Workout</button>
          </td>
        </tr>
      </tfoot>
    </table>
    <h3>Notes</h3>
    <textarea id="notes" rows="4" placeholder="Additional notes..."></textarea>
  </div>

  <!-- Other pages (Daily, Nutrition, Cardio, etc.) unchanged -->
  <div id="daily" class="page">...</div>
  <div id="nutrition" class="page">...</div>
  <div id="cardio" class="page">...</div>
  <div id="performance" class="page">...</div>
  <div id="calculators" class="page">...</div>
  <div id="progress" class="page">...</div>
  <div id="hypertrophy" class="page">...</div>
  <div id="strength" class="page">...</div>
  <div id="mesocycle" class="page">...</div>
  <div id="history" class="page">...</div>
  <div id="analytics" class="page">...</div>

  <!-- Libs (Add Firebase CDN for simplicity, or use npm) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script type="module">
    // Firebase imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    // Firebase config (replace with your Firebase project config)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      // ... other fields from Firebase Console
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Your existing arrays (exercises, muscles, etc.) unchanged
    const exercises = [/* Your exercises array */];
    const muscles = [/* Your muscles array */];
    const initialHypertrophy = {/* Your initialHypertrophy object */};
    const initialStickingPoints = {/* Your initialStickingPoints object */};
    const suggestions = {/* Your suggestions object */};

    /* -------------------- WORKOUT -------------------- */
    let setNumber = 0;

    function addSet(ex="Exercise", wt="", reps="", rir="", pump="No", felt="", rest=120, e1rm=0) {
      setNumber++;
      const tr = document.createElement("tr");
      tr.className = "set-row";
      tr.innerHTML = `
        <td><input value="${ex}" onchange="calculateAll()"></td>
        <td>${setNumber}</td>
        <td><input type="number" value="${wt}" onchange="calculateAll()"></td>
        <td><span class="delta"></span></td>
        <td><input type="number" value="${reps}" onchange="calculateAll()"></td>
        <td><input type="number" value="${rir}" onchange="calculateAll()"></td>
        <td><select onchange="calculateAll()"><option ${pump==="No"?"selected":""}>No</option><option ${pump==="Yes"?"selected":""}>Yes</option></select></td>
        <td><input value="${felt}"></td>
        <td><input type="number" value="${rest}" onchange="calculateAll()"></td>
        <td><span>${e1rm}</span></td>
        <td><button onclick="this.closest('tr').remove();updateSetNumbers();calculateAll()">Remove</button></td>`;
      document.getElementById("table-body").appendChild(tr);
      calculateAll();
    }

    function updateSetNumbers() {
      const rows = document.querySelectorAll("#table-body .set-row");
      rows.forEach((r, i) => r.cells[1].textContent = i + 1);
      setNumber = rows.length;
    }

    function calculateAll() {
      let vol = 0, sets = 0;
      let prevWeight = 0;
      document.querySelectorAll("#table-body .set-row").forEach((r, index) => {
        const w = +r.cells[2].querySelector("input").value || 0;
        const reps = +r.cells[4].querySelector("input").value || 0;
        const rirI = r.cells[5].querySelector("input");
        let rir = +rirI.value || 0;
        rir = Math.max(0, Math.min(4, rir));
        rirI.value = rir;
        const deltaSpan = r.cells[3].querySelector(".delta");
        if (index > 0) {
          const delta = w - prevWeight;
          deltaSpan.textContent = delta > 0 ? `+${delta}` : delta;
          deltaSpan.className = `delta ${delta > 0 ? 'positive' : (delta < 0 ? 'negative' : '')}`;
        } else {
          deltaSpan.textContent = '';
        }
        prevWeight = w;
        if (w && reps) {
          vol += w * reps;
          sets++;
          r.cells[9].querySelector("span").textContent = Math.round(w * (36 / (37 - reps)));
        }
      });
      document.getElementById("total-volume").innerHTML = `Total Volume: ${vol} lbs | Total Sets: ${sets} | Volume Category: ${getVolumeCategory(sets)}`;
    }

    function getVolumeCategory(sets) {
      if (sets < 10) return 'Low';
      if (sets < 20) return 'Medium';
      return 'High';
    }

    async function saveWorkout() {
      const memberId = document.getElementById("memberId").value;
      if (!memberId) {
        alert("Please enter a Member ID.");
        return;
      }
      const rows = [];
      document.querySelectorAll("#table-body .set-row").forEach(r => {
        rows.push({
          exercise: r.cells[0].querySelector("input").value,
          set: r.cells[1].textContent,
          weight: r.cells[2].querySelector("input").value,
          reps: r.cells[4].querySelector("input").value,
          rir: r.cells[5].querySelector("input").value,
          pump: r.cells[6].querySelector("select").value,
          felt: r.cells[7].querySelector("input").value,
          rest: r.cells[8].querySelector("input").value,
          e1rm: r.cells[9].querySelector("span").textContent
        });
      });
      const notes = document.getElementById("notes").value;
      const dateInput = document.getElementById("workout-date").value;
      const dateKey = dateInput || new Date().toISOString().split("T")[0];
      try {
        await addDoc(collection(db, `workouts_${memberId}`), {
          rows,
          notes,
          date: dateKey,
          timestamp: new Date().toISOString()
        });
        alert("Workout saved to Firestore!");
        displayWorkouts(memberId, dateKey);
      } catch (error) {
        console.error("Error saving workout:", error);
        alert("Error saving workout.");
      }
    }

    async function displayWorkouts(memberId, dateKey) {
      const q = query(collection(db, `workouts_${memberId}`), where("date", "==", dateKey), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      const tb = document.getElementById("table-body");
      tb.innerHTML = "";
      setNumber = 0;
      let vol = 0, sets = 0;
      snapshot.forEach(doc => {
        const d = doc.data();
        d.rows.forEach(r => {
          addSet(r.exercise, r.weight, r.reps, r.rir, r.pump, r.felt, r.rest, r.e1rm);
          vol += (+r.weight || 0) * (+r.reps || 0);
          sets++;
        });
        document.getElementById("notes").value = d.notes || "";
        document.getElementById("workout-date").value = d.date;
      });
      document.getElementById("total-volume").innerHTML = `Total Volume: ${vol} lbs | Total Sets: ${sets} | Volume Category: ${getVolumeCategory(sets)}`;
    }

    /* -------------------- HISTORY (Updated for Firestore) -------------------- */
    async function loadHistory() {
      const tb = document.querySelector("#history-table tbody");
      tb.innerHTML = "";
      const memberId = document.getElementById("memberId").value;
      if (!memberId) {
        alert("Please enter a Member ID to view history.");
        return;
      }
      const q = query(collection(db, `workouts_${memberId}`), orderBy("date", "desc"));
      const snapshot = await getDocs(q);
      snapshot.forEach(doc => {
        const d = doc.data();
        const vol = d.rows.reduce((sum, r) => sum + (+r.weight * +r.reps), 0);
        tb.innerHTML += `<tr>
          <td>${d.date}</td>
          <td>${Math.round(vol)}</td>
          <td>${d.notes || ""}</td>
          <td>
            <button onclick="loadSpecific('${memberId}', '${d.date}')">View</button>
            <button onclick="downloadCSV('${memberId}', '${d.date}')">CSV</button>
            <button onclick="deleteWorkout('${memberId}', '${doc.id}')">Delete</button>
          </td>
        </tr>`;
      });
    }

    async function loadSpecific(memberId, dateKey) {
      const q = query(collection(db, `workouts_${memberId}`), where("date", "==", dateKey));
      const snapshot = await getDocs(q);
      const tb = document.getElementById("table-body");
      tb.innerHTML = "";
      setNumber = 0;
      snapshot.forEach(doc => {
        const d = doc.data();
        d.rows.forEach(r => addSet(r.exercise, r.weight, r.reps, r.rir, r.pump, r.felt, r.rest, r.e1rm));
        document.getElementById("notes").value = d.notes;
        document.getElementById("workout-date").value = d.date;
      });
      showPage("workout");
    }

    async function downloadCSV(memberId, dateKey) {
      const q = query(collection(db, `workouts_${memberId}`), where("date", "==", dateKey));
      const snapshot = await getDocs(q);
      let csv = "Exercise,Set,Weight,Delta,Reps,RIR,Pump,Felt,Rest,e1RM\n";
      snapshot.forEach(doc => {
        const d = doc.data();
        d.rows.forEach(r => {
          csv += `${r.exercise},${r.set},${r.weight},,${r.reps},${r.rir},${r.pump},${r.felt},${r.rest},${r.e1rm}\n`;
        });
        csv += `Notes:,${(d.notes || "").replace(/[\n\r]/g, " ")}\n`;
      });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
      link.download = `${dateKey}-workout.csv`;
      link.click();
    }

    async function deleteWorkout(memberId, docId) {
      if (confirm("Delete this workout?")) {
        await deleteDoc(doc(db, `workouts_${memberId}`, docId));
        loadHistory();
      }
    }

    /* -------------------- Your Existing Functions (Unchanged) -------------------- */
    function showPage(id) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (id === "history") loadHistory();
      if (id === "analytics") loadAnalytics();
      if (id === "progress") loadProgress();
      if (id === "hypertrophy") loadHypertrophy();
      if (id === "strength") { loadStrength(); loadRepMax(); loadStickingPoints(); }
      if (id === "mesocycle") loadMesocycle();
      if (id === "workout") setWorkoutDate();
    }

    function setWorkoutDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("workout-date").value = today;
    }

    function addDaily(date="",pain="",warm="",tired="",sore="",desire="",notes="") {
      // Your existing addDaily function unchanged
    }
    function saveDaily() {
      // Your existing saveDaily function unchanged
    }
    function addNutrition(date="",cals="",weight="",steps="",fat="",carbs="",protein="",sleep="",rhr="",hrv="") {
      // Your existing addNutrition function unchanged
    }
    function saveNutrition() {
      // Your existing saveNutrition function unchanged
    }
    function addCardio(date="", exercise="", minutes="", speed="", incline="", hrAvg="") {
      // Your existing addCardio function unchanged
    }
    function saveCardio() {
      // Your existing saveCardio function unchanged
    }
    function addPerformance(date="",lift="",e1rm="",status="") {
      // Your existing addPerformance function unchanged
    }
    function savePerformance() {
      // Your existing savePerformance function unchanged
    }
    function loadRepMax() {
      // Your existing loadRepMax function unchanged
    }
    function saveRepMax() {
      // Your existing saveRepMax function unchanged
    }
    function loadStickingPoints() {
      // Your existing loadStickingPoints function unchanged
    }
    function saveStickingPoints() {
      // Your existing saveStickingPoints function unchanged
    }
    function loadHypertrophy() {
      // Your existing loadHypertrophy function unchanged
    }
    function saveHypertrophy() {
      // Your existing saveHypertrophy function unchanged
    }
    function loadStrength() {
      // Your existing loadStrength function unchanged
    }
    function saveStrength() {
      // Your existing saveStrength function unchanged
    }
    function loadMesocycle() {
      // Your existing loadMesocycle function unchanged
    }
    function saveMesocycle() {
      // Your existing saveMesocycle function unchanged
    }
    function loadProgress() {
      // Your existing loadProgress function unchanged
    }
    function calc1RM() {
      // Your existing calc1RM function unchanged
    }
    function calcBMI() {
      // Your existing calcBMI function unchanged
    }
    function calcBMR() {
      // Your existing calcBMR function unchanged
    }
    function calcMacros() {
      // Your existing calcMacros function unchanged
    }
    function calcWilks() {
      // Your existing calcWilks function unchanged
    }
    let e1rmChart;
    function loadAnalytics() {
      // Your existing loadAnalytics function unchanged
    }

    /* -------------------- INIT -------------------- */
    window.onload = function() {
      setWorkoutDate();
      addSet("Lowbar Squat", 315, 5, 2, "No", "Quads", 120, 354);
      calculateAll();
      // Your existing initialization for other logs unchanged
      let daily = JSON.parse(localStorage.getItem("daily-log") || "[]");
      if (daily.length === 0) {
        addDaily("", "Mild discomfort", "Light", "A little tired", "Mild soreness", "High", "Upper");
        addDaily("", "Mild discomfort", "Did not train", "A little tired", "Mild soreness", "Average", "Lower");
        addDaily("", "Local joint pain discomfort", "Light", "A little tired", "Feel great", "High", "Push");
        addDaily("", "Local joint pain discomfort", "Heavy", "Tired on average", "Mild soreness", "Low", "Pull");
        addDaily("", "", "", "", "", "", "Rest day");
        daily = [
          {date: "", pain: "Mild discomfort", warm: "Light", tired: "A little tired", sore: "Mild soreness", desire: "High", notes: "Upper"},
          {date: "", pain: "Mild discomfort", warm: "Did not train", tired: "A little tired", sore: "Mild soreness", desire: "Average", notes: "Lower"},
          {date: "", pain: "Local joint pain discomfort", warm: "Light", tired: "A little tired", sore: "Feel great", desire: "High", notes: "Push"},
          {date: "", pain: "Local joint pain discomfort", warm: "Heavy", tired: "Tired on average", sore: "Mild soreness", desire: "Low", notes: "Pull"},
          {date: "", pain: "", warm: "", tired: "", sore: "", desire: "", notes: "Rest day"}
        ];
        localStorage.setItem("daily-log", JSON.stringify(daily));
      } else {
        daily.forEach(d => addDaily(d.date, d.pain, d.warm, d.tired, d.sore, d.desire, d.notes));
      }
      const nutrition = JSON.parse(localStorage.getItem("nutrition-log") || "[]");
      nutrition.forEach(n => addNutrition(n.date, n.cals, n.weight, n.steps, n.fat, n.carbs, n.protein, n.sleep, n.rhr, n.hrv));
      const perf = JSON.parse(localStorage.getItem("performance-log") || "[]");
      perf.forEach(p => addPerformance(p.date, p.lift, p.e1rm, p.status));
      const cardio = JSON.parse(localStorage.getItem("cardio-log") || "[]");
      if (cardio.length === 0) {
        addCardio("2025-02-03", "Treadmill", 30, 3, 3, 122);
        localStorage.setItem("cardio-log", JSON.stringify([{date: "2025-02-03", exercise: "Treadmill", minutes: 30, speed: 3, incline: 3, hrAvg: 122}]));
      } else {
        cardio.forEach(c => addCardio(c.date, c.exercise, c.minutes, c.speed, c.incline, c.hrAvg));
      }
      // Add event listener for memberId change to load workouts
      document.getElementById("memberId").addEventListener("change", (e) => {
        const dateInput = document.getElementById("workout-date").value;
        const dateKey = dateInput || new Date().toISOString().split("T")[0];
        displayWorkouts(e.target.value, dateKey);
      });
    };
  </script>
</body>
</html>

